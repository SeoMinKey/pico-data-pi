<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IoT í™˜ê²½ ëª¨ë‹ˆí„°ë§ (Pico AP ëª¨ë“œ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* --- (ìˆ˜ì •) AP ëª¨ë“œ ì•ˆë‚´ì°½ ìŠ¤íƒ€ì¼ --- */
      .ap-instructions {
        background: #fff8e1; /* ë…¸ë€ìƒ‰ ë°°ê²½ */
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .ap-instructions h2 {
        margin-top: 0;
        color: #e65100;
        text-align: center;
      }
      .ap-instructions ol {
        margin-left: 20px;
        line-height: 1.6;
        font-size: 1.1rem;
      }
      /* --- (ê¸°ì¡´ CSSì™€ ë™ì¼) --- */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Roboto", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f8f9fa;
        min-height: 100vh;
        color: #212121;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        padding-top: 100px;
      }
      .header {
        background: white;
        padding: 16px 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        width: 100%;
        box-sizing: border-box;
      }
      .logo {
        height: 40px;
        width: auto;
        object-fit: contain;
      }
      .header-content {
        text-align: center;
        flex: 1;
      }
      .header-content h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #000000;
        margin: 0;
        line-height: 1.2;
      }
      .header-content p {
        font-size: 0.875rem;
        color: #666;
        font-weight: 400;
        margin: 0;
        margin-top: 2px;
      }
      .header-spacer {
        width: 40px;
      }
      .controls {
        background: white;
        padding: 25px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
      }
      .control-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        min-width: 150px;
      }
      .control-group label {
        font-weight: 600;
        color: #555;
        font-size: 0.9rem;
      }
      .slider {
        width: 150px;
        height: 4px;
        border-radius: 2px;
        background: #e0e0e0;
        outline: none;
      }
      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #1976d2;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #1976d2;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        min-width: 120px;
      }
      .btn.giant {
        padding: 20px 40px;
        font-size: 1.2rem;
        font-weight: 600;
        min-width: 200px;
        border-radius: 8px;
      }
      .btn-primary {
        background: #1976d2;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .btn-primary:hover {
        background: #1565c0;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }
      .btn-primary:active {
        background: #0d47a1;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }
      /* (ì¶”ê°€) ì•ŒëŒ ë¹„í™œì„±í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .btn-warning {
        background: #f57c00;
        color: white;
      }
      .btn-warning:hover {
        background: #e65100;
      }
      /* (ì¶”ê°€) ì—°ê²° í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .btn-secondary {
        padding: 10px 15px;
        font-size: 0.9rem;
        background: #6c757d;
        color: white;
        white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
      }
      .btn-secondary:hover {
        background: #5a6268;
      }
      .status {
        padding: 6px 12px;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 6px;
        min-width: 100px;
        justify-content: center;
      }
      .status.giant {
        padding: 20px 40px;
        border-radius: 8px;
        font-size: 1.2rem;
        font-weight: 600;
        min-width: 200px;
        gap: 10px;
      }
      .status.small {
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: 500;
        min-width: 120px;
        gap: 6px;
      }
      .status.active {
        background: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #4caf50;
      }
      .status.paused {
        background: #fff3e0;
        color: #f57c00;
        border: 1px solid #ff9800;
      }
      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }
      .status.giant .status-indicator {
        width: 12px;
        height: 12px;
      }
      .status-indicator.active {
        background: #4caf50;
      }
      .status-indicator.paused {
        background: #ff9800;
      }
      .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
        justify-items: center;
      }
      .metric-card {
        background: white;
        padding: 25px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        text-align: center;
        transition: box-shadow 0.2s ease;
        width: 200px;
        height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
      }
      .metric-card:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
      }
      .metric-icon {
        font-size: 2rem;
        margin-bottom: 8px;
      }
      .metric-label {
        font-size: 1.2rem;
        color: #666;
        margin-bottom: 8px;
        font-weight: 500;
      }
      .metric-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #333;
        line-height: 1;
      }
      .metric-unit {
        font-size: 0.8rem;
        color: #888;
        margin-left: 3px;
      }
      .metric-status {
        font-size: 0.9rem;
        font-weight: 600;
        margin-top: 8px;
        padding: 4px 8px;
        border-radius: 12px;
        text-align: center;
      }
      .metric-status.normal {
        background: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #4caf50;
      }
      .metric-status.danger {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #f44336;
      }
      .charts-container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
      }
      .chart-container {
        position: relative;
        height: 300px;
        background: #fafafa;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
      }
      .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        text-align: center;
      }
      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }
        .header h1 {
          font-size: 2rem;
        }
        .controls {
          flex-direction: column;
          gap: 20px;
        }
        .metrics {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        .charts-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- ìƒë‹¨ ê³ ì •ë°” -->
      <div class="header">
        <img src="logo.png" alt="Gongdo Logo" class="logo" />
        <div class="header-content">
          <h1>IoT ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ (Pico AP)</h1>
        </div>
        <div class="header-spacer"></div>
      </div>

      <!-- AP ëª¨ë“œ ì—°ê²° ì•ˆë‚´ -->
      <div class="ap-instructions">
        <h2>âš ï¸ AP ëª¨ë“œ ì—°ê²° ì•ˆë‚´</h2>
        <ol>
          <li>
            ë…¸íŠ¸ë¶/PCì˜ Wi-Fi ì„¤ì •ì—ì„œ <strong>"rp_pico_00(ìˆ˜ì •í•œ ë‘ìë¦¬ ìˆ«ì)"</strong>ë¥¼ ì°¾ì•„
            ì—°ê²°í•˜ì„¸ìš”.
          </li>
          <li>ë¹„ë°€ë²ˆí˜¸ëŠ” <strong>12345678</strong> ì…ë‹ˆë‹¤.</li>
          <li>
            ì—°ê²°ì´ ì™„ë£Œë˜ë©´ <strong>[ì—°ê²° í…ŒìŠ¤íŠ¸]</strong> ë²„íŠ¼ì„, ì´í›„
            <strong>[ëª¨ë‹ˆí„°ë§ ì‹œì‘]</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
          </li>
        </ol>
      </div>

      <!-- Controls (ìˆ˜ì •ë¨) -->
      <div class="controls">
        <!-- ê°±ì‹  ì£¼ê¸° ìŠ¬ë¼ì´ë” -->
        <div class="control-group">
          <label for="interval">ë°ì´í„° ê°±ì‹  ì£¼ê¸° (ì´ˆ)</label>
          <input
            type="range"
            id="interval"
            class="slider"
            min="0.5"
            max="5"
            step="0.5"
            value="1"
          />
          <span id="intervalValue">1.0ì´ˆ</span>
        </div>
        
        <!-- ì˜¨ë„ ì•ŒëŒ ì„ê³„ì  ìŠ¬ë¼ì´ë” -->
        <div class="control-group">
          <label for="tempAlarmSlider">ì˜¨ë„ ì•ŒëŒ ì„ê³„ì  (Â°C)</label>
          <input
            type="range"
            id="tempAlarmSlider"
            class="slider"
            min="20"
            max="50"
            step="1"
            value="50"
          />
          <span id="tempAlarmValue">ë¹„í™œì„±í™”</span>
        </div>

        <!-- ìŠµë„ ì•ŒëŒ ì„ê³„ì  ìŠ¬ë¼ì´ë” -->
        <div class="control-group">
          <label for="humAlarmSlider">ìŠµë„ ì•ŒëŒ ì„ê³„ì  (%)</label>
          <input
            type="range"
            id="humAlarmSlider"
            class="slider"
            min="0"
            max="100"
            step="5"
            value="100"
          />
          <span id="humAlarmValue">ë¹„í™œì„±í™”</span>
        </div>

        <!-- ì¡°ë„ ì•ŒëŒ ì„ê³„ì  ìŠ¬ë¼ì´ë” -->
        <div class="control-group">
          <label for="lightAlarmSlider">ì¡°ë„ ì•ŒëŒ ì„ê³„ì  (lx)</label>
          <input
            type="range"
            id="lightAlarmSlider"
            class="slider"
            min="0"
            max="1000"
            step="50"
            value="1000"
          />
          <span id="lightAlarmValue">ë¹„í™œì„±í™”</span>
        </div>
        
        <!-- ìƒíƒœ í‘œì‹œ -->
        <div id="status" class="status paused small">
          <div class="status-indicator paused"></div>
          ìƒíƒœ: ëŒ€ê¸° ì¤‘
        </div>
        <div id="picoStatus" class="status paused small">
          <div class="status-indicator paused"></div>
          í”¼ì½”: ì—°ê²° ì•ˆë¨
        </div>
        
        <!-- ë²„íŠ¼ -->
        <button id="startBtn" class="btn btn-primary giant">
          ëª¨ë‹ˆí„°ë§ ì‹œì‘
        </button>
        <button id="disableAlarmBtn" class="btn btn-warning">
          ì•ŒëŒ ë¹„í™œì„±í™”
        </button>
        <!-- (ì¶”ê°€) ì—°ê²° í…ŒìŠ¤íŠ¸ ë²„íŠ¼ -->
        <button id="testConnectionBtn" class="btn btn-secondary">
          ì—°ê²° í…ŒìŠ¤íŠ¸
        </button>
      </div>

      <!-- Metrics -->
      <div class="metrics">
        <div class="metric-card">
          <div class="metric-icon">ğŸŒ¡ï¸</div>
          <div class="metric-label">ì˜¨ë„</div>
          <div class="metric-value">
            <span id="tempValue">--</span>
            <span class="metric-unit">Â°C</span>
          </div>
          <div class="metric-status normal" id="tempStatus">ëŒ€ê¸°</div>
        </div>
        <div class="metric-card">
          <div class="metric-icon">ğŸ’§</div>
          <div class="metric-label">ìŠµë„</div>
          <div class="metric-value">
            <span id="humidityValue">--</span>
            <span class="metric-unit">%</span>
          </div>
          <div class="metric-status normal" id="humidityStatus">ëŒ€ê¸°</div>
        </div>
        <div class="metric-card">
          <div class="metric-icon">ğŸ’¡</div>
          <div class="metric-label">ì¡°ë„</div>
          <div class="metric-value">
            <span id="lightValue">--</span>
            <span class="metric-unit">lx</span>
          </div>
          <div class="metric-status normal" id="lightStatus">ëŒ€ê¸°</div>
        </div>
      </div>
      
      <!-- Charts -->
      <div class="charts-container">
        <h2 style="text-align: center; margin-bottom: 30px; color: #333">
          ì‹¤ì‹œê°„ ë°ì´í„° ì¶”ì´
        </h2>
        <div class="charts-grid">
          <div class="chart-container">
            <div class="chart-title">ì˜¨ë„</div>
            <canvas id="tempChart"></canvas>
          </div>
          <div class="chart-container">
            <div class="chart-title">ìŠµë„</div>
            <canvas id="humidityChart"></canvas>
          </div>
          <div class="chart-container">
            <div class="chart-title">ì¡°ë„</div>
            <canvas id="lightChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let isCollecting = false;
      let interval = 1000;
      let dataInterval;

      // (ìˆ˜ì •) AP ëª¨ë“œì˜ ê³ ì • IP
      const PICO_IP = "192.168.4.1";
      const PICO_API_URL = `http://${PICO_IP}/sensors`; 
      const PICO_ALARM_URL = `http://${PICO_IP}/alarm_threshold`; // (ì¶”ê°€)

      // Chart configurations
      const chartConfig = {
        type: "line",
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: true, grid: { color: "rgba(0,0,0,0.1)" } },
            y: { display: true, grid: { color: "rgba(0,0,0,0.1)" } },
          },
          elements: { point: { radius: 3, hoverRadius: 6 }, line: { borderWidth: 2 } },
        },
      };

      // Initialize charts
      const tempCtx = document.getElementById("tempChart").getContext("2d");
      const humidityCtx = document.getElementById("humidityChart").getContext("2d");
      const lightCtx = document.getElementById("lightChart").getContext("2d"); 

      const tempChart = new Chart(tempCtx, {
        ...chartConfig,
        data: {
          labels: [],
          datasets: [
            {
              label: "ì˜¨ë„",
              data: [],
              borderColor: "#f44336",
              backgroundColor: "rgba(244, 67, 54, 0.1)",
              fill: true,
            },
            {
              label: "ìœ„í—˜ ì˜¨ë„",
              data: [],
              borderColor: "#424242",
              backgroundColor: "transparent",
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              pointHoverRadius: 0,
              fill: false,
            },
          ],
        },
      });

      const humidityChart = new Chart(humidityCtx, {
        ...chartConfig,
        options: { ...chartConfig.options, scales: { ...chartConfig.options.scales, y: { ...chartConfig.options.scales.y, beginAtZero: true } } },
        data: {
          labels: [],
          datasets: [
            { data: [], borderColor: "#ff9800", backgroundColor: "rgba(255, 152, 0, 0.1)", fill: true },
            {
              label: "ìœ„í—˜ ìŠµë„",
              data: [],
              borderColor: "#424242",
              backgroundColor: "transparent",
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              pointHoverRadius: 0,
              fill: false,
            },
          ],
        },
      });

      const lightChart = new Chart(lightCtx, {
        ...chartConfig,
        options: { ...chartConfig.options, scales: { ...chartConfig.options.scales, y: { ...chartConfig.options.scales.y, beginAtZero: true } } },
        data: {
          labels: [],
          datasets: [
            { data: [], borderColor: "#fdd835", backgroundColor: "rgba(253, 216, 53, 0.1)", fill: true },
            {
              label: "ìœ„í—˜ ì¡°ë„",
              data: [],
              borderColor: "#424242",
              backgroundColor: "transparent",
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              pointHoverRadius: 0,
              fill: false,
            },
          ],
        },
      });
      
      // (ì¶”ê°€) ì•ŒëŒ ì„ê³„ê°’ì„ í”¼ì½”ë¡œ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
      async function sendAlarmThresholds() {
        const thresholds = {
            temperature: parseFloat(document.getElementById("tempAlarmSlider").value),
            humidity: parseFloat(document.getElementById("humAlarmSlider").value),
            light: parseFloat(document.getElementById("lightAlarmSlider").value)
        };
        
        const highValue = 1000000;
        if (thresholds.temperature >= 50) thresholds.temperature = highValue;
        if (thresholds.humidity >= 100) thresholds.humidity = highValue;
        if (thresholds.light >= 1000) thresholds.light = highValue;

        console.log("ìƒˆ ì„ê³„ê°’ ì „ì†¡ ì‹œë„:", thresholds);
        
        try {
          const response = await fetch(PICO_ALARM_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(thresholds)
          });
          if (response.ok) {
            console.log(`ì„±ê³µ: ìƒˆ ì•ŒëŒ ì„ê³„ê°’ ì „ì†¡ ì™„ë£Œ`, thresholds);
          } else {
            console.error(`ì‹¤íŒ¨: ì„ê³„ê°’ ì „ì†¡ ì‹¤íŒ¨ (HTTP ${response.status})`);
          }
        } catch (error) {
          console.error("ì„ê³„ê°’ ì „ì†¡ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
          updatePicoStatus(false);
        }
      }

      // (ìˆ˜ì •) Fetch data from Raspberry Pi Pico (AP ëª¨ë“œ)
      async function fetchPicoData() {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 2000); 

          const response = await fetch(PICO_API_URL, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
            signal: controller.signal,
          });
          clearTimeout(timeoutId);

          if (response.ok) {
            const picoData = await response.json();
            updateMetrics(picoData);
            updateCharts(picoData);
            updatePicoStatus(true);
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.log("Pico not connected:", error.message);
          updatePicoStatus(false);
        }
      }

      // Update Pico connection status display
      function updatePicoStatus(connected) {
        const picoStatus = document.getElementById("picoStatus");
        if (connected) {
          picoStatus.innerHTML =
            '<div class="status-indicator active"></div>í”¼ì½”: ì—°ê²°ë¨';
          picoStatus.className = "status active small";
        } else {
          picoStatus.innerHTML =
            '<div class="status-indicator paused"></div>í”¼ì½”: ì—°ê²° ì•ˆë¨';
          picoStatus.className = "status paused small";
        }
      }

      // (ìˆ˜ì •) Update metrics display (ì¡°ë„ ì¶”ê°€, ì†Œë¦¬/ìˆ˜ìœ„ ì œê±°)
      function updateMetrics(data) {
        if (data.error) {
            console.error("Sensor error:", data.error);
            updatePicoStatus(false);
            return;
        }
        document.getElementById("tempValue").textContent = data.temperature;
        document.getElementById("humidityValue").textContent = data.humidity;
        document.getElementById("lightValue").textContent = data.light; 
        updateStatusIndicators(data);
      }

      // (ìˆ˜ì •) Update status indicators (ì¡°ë„ ì¶”ê°€, ì†Œë¦¬/ìˆ˜ìœ„ ì œê±°)
      function updateStatusIndicators(data) {
        const tempStatus = document.getElementById("tempStatus");
        if (data.alarm) { 
          tempStatus.textContent = "ìœ„í—˜";
          tempStatus.className = "metric-status danger";
        } else {
          tempStatus.textContent = "ì •ìƒ";
          tempStatus.className = "metric-status normal";
        }
        
        // (ìˆ˜ì •) ìŠµë„ì™€ ì¡°ë„ ìƒíƒœë„ ì•ŒëŒ í”Œë˜ê·¸ì— ì—°ë™
        const humStatus = document.getElementById("humidityStatus");
        humStatus.textContent = data.alarm ? "ìœ„í—˜" : "ì •ìƒ";
        humStatus.className = data.alarm ? "metric-status danger" : "metric-status normal";
        
        const lightStatus = document.getElementById("lightStatus");
        lightStatus.textContent = data.alarm ? "ìœ„í—˜" : "ì •ìƒ";
        lightStatus.className = data.alarm ? "metric-status danger" : "metric-status normal";
      }

      // (ìˆ˜ì •) Update charts (ì¡°ë„ ì¶”ê°€, ì†Œë¦¬/ìˆ˜ìœ„ ì œê±°)
      function updateCharts(data) {
        if (data.error) return; 
        
        const now = new Date().toLocaleTimeString();

        // (ìˆ˜ì •) ì°¨íŠ¸ì˜ ì„ê³„ì„ ë„ UI ìŠ¬ë¼ì´ë” ê°’ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ë³€ê²½
        const tempThreshold = parseFloat(document.getElementById("tempAlarmSlider").value);
        const humThreshold = parseFloat(document.getElementById("humAlarmSlider").value);
        const lightThreshold = parseFloat(document.getElementById("lightAlarmSlider").value);
        
        // ì˜¨ë„ ì°¨íŠ¸
        tempChart.data.labels.push(now);
        tempChart.data.datasets[0].data.push(data.temperature);
        tempChart.data.datasets[1].data.push(tempThreshold >= 50 ? null : tempThreshold);
        if (tempChart.data.labels.length > 20) {
          tempChart.data.labels.shift();
          tempChart.data.datasets[0].data.shift();
          tempChart.data.datasets[1].data.shift();
        }
        tempChart.update("none");

        // ìŠµë„ ì°¨íŠ¸
        humidityChart.data.labels.push(now);
        humidityChart.data.datasets[0].data.push(data.humidity);
        humidityChart.data.datasets[1].data.push(humThreshold >= 100 ? null : humThreshold); 
        if (humidityChart.data.labels.length > 20) {
          humidityChart.data.labels.shift();
          humidityChart.data.datasets[0].data.shift();
          humidityChart.data.datasets[1].data.shift(); 
        }
        humidityChart.update("none");

        // ì¡°ë„ ì°¨íŠ¸
        lightChart.data.labels.push(now);
        lightChart.data.datasets[0].data.push(data.light);
        lightChart.data.datasets[1].data.push(lightThreshold >= 1000 ? null : lightThreshold); 
        if (lightChart.data.labels.length > 20) {
          lightChart.data.labels.shift();
          lightChart.data.datasets[0].data.shift();
          lightChart.data.datasets[1].data.shift(); 
        }
        lightChart.update("none");
      }

      // (ìˆ˜ì •) Start/stop data collection
      function toggleCollection() {
        if (isCollecting) {
          clearInterval(dataInterval);
          isCollecting = false;
          document.getElementById("startBtn").textContent = "ëª¨ë‹ˆí„°ë§ ì‹œì‘";
          document.getElementById("status").innerHTML =
            '<div class="status-indicator paused"></div>ìƒíƒœ: ì¤‘ì§€ë¨';
          document.getElementById("status").className = "status paused small";
        } else {
          fetchPicoData(); 
          dataInterval = setInterval(fetchPicoData, interval);
          
          isCollecting = true;
          document.getElementById("startBtn").textContent = "ëª¨ë‹ˆí„°ë§ ì¤‘ì§€";
          document.getElementById("status").innerHTML =
            '<div class="status-indicator active"></div>ìƒíƒœ: ëª¨ë‹ˆí„°ë§ ì¤‘';
          document.getElementById("status").className = "status active small";
        }
      }

      // (ìˆ˜ì •) Test Pico connection (AP ëª¨ë“œ)
      async function testPicoConnection() {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 2000);
          
          const response = await fetch(PICO_API_URL, { signal: controller.signal });
          clearTimeout(timeoutId);
          
          updatePicoStatus(response.ok);
          if(response.ok) {
            alert("âœ… í”¼ì½” ì—°ê²° ì„±ê³µ! (AP ëª¨ë“œ)");
          } else {
            alert("âŒ í”¼ì½” ì—°ê²° ì‹¤íŒ¨: WiFiê°€ 'test_rp'ì— ì—°ê²°ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
          }
        } catch (error) {
          updatePicoStatus(false);
          alert("âŒ í”¼ì½” ì—°ê²° ì‹¤íŒ¨: WiFiê°€ 'test_rp'ì— ì—°ê²°ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
        }
      }
      
      // (ì¶”ê°€) ë¹„í™œì„±í™” ë²„íŠ¼ìš© ì „ì†¡ í•¨ìˆ˜
      async function sendDirectAlarmThresholds(thresholds) {
        try {
          const response = await fetch(PICO_ALARM_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(thresholds)
          });
          if (response.ok) {
            console.log("ì„±ê³µ: ì•ŒëŒ ë¹„í™œì„±í™” ì™„ë£Œ", thresholds);
          } else {
            console.error(`ì‹¤íŒ¨: ì•ŒëŒ ë¹„í™œì„±í™” ì‹¤íŒ¨ (HTTP ${response.status})`);
          }
        } catch (error) {
          console.error("ì•ŒëŒ ë¹„í™œì„±í™” ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
          updatePicoStatus(false);
        }
      }

      // Event listeners
      document.addEventListener("DOMContentLoaded", function () {
        
        const startBtn = document.getElementById("startBtn");
        startBtn.addEventListener("click", toggleCollection);
        
        // (ì¶”ê°€) ì—°ê²° í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
        const testBtn = document.getElementById("testConnectionBtn");
        testBtn.addEventListener("click", testPicoConnection);

        const intervalSlider = document.getElementById("interval");
        intervalSlider.addEventListener("input", function () {
            interval = this.value * 1000;
            document.getElementById("intervalValue").textContent = this.value + "ì´ˆ";
            if (isCollecting) {
              clearInterval(dataInterval);
              dataInterval = setInterval(fetchPicoData, interval);
            }
        });
        
        // --- 3ê°œì˜ ì•ŒëŒ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        const tempSlider = document.getElementById("tempAlarmSlider");
        const humSlider = document.getElementById("humAlarmSlider");
        const lightSlider = document.getElementById("lightAlarmSlider");
        const highValue = 1000000;

        // UI í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ë“œë˜ê·¸ ì¤‘ ì‹¤ì‹œê°„)
        tempSlider.addEventListener("input", () => {
             const val = parseFloat(tempSlider.value);
             document.getElementById("tempAlarmValue").textContent = 
                (val >= 50) ? "ë¹„í™œì„±í™”" : val.toFixed(1) + "Â°C";
        });
        humSlider.addEventListener("input", () => {
             const val = parseFloat(humSlider.value);
             document.getElementById("humAlarmValue").textContent = 
                (val >= 100) ? "ë¹„í™œì„±í™”" : val.toFixed(1) + "%";
        });
        lightSlider.addEventListener("input", () => {
             const val = parseFloat(lightSlider.value);
             document.getElementById("lightAlarmValue").textContent = 
                (val >= 1000) ? "ë¹„í™œì„±í™”" : val.toFixed(0) + " lx";
        });

        // í”¼ì½”ë¡œ ë°ì´í„° ì „ì†¡ (ë§ˆìš°ìŠ¤ë¥¼ ë†“ì•˜ì„ ë•Œ)
        tempSlider.addEventListener("change", sendAlarmThresholds);
        humSlider.addEventListener("change", sendAlarmThresholds);
        lightSlider.addEventListener("change", sendAlarmThresholds);
        
        // ì•ŒëŒ ë¹„í™œì„±í™” ë²„íŠ¼
        document.getElementById("disableAlarmBtn").addEventListener("click", () => {
            
            // 1. UI ìŠ¬ë¼ì´ë”ì™€ í…ìŠ¤íŠ¸ë¥¼ ìµœëŒ€/ë¹„í™œì„±í™” ìƒíƒœë¡œ ë³€ê²½
            tempSlider.value = 50; 
            humSlider.value = 100;
            lightSlider.value = 1000;
            document.getElementById("tempAlarmValue").textContent = "ë¹„í™œì„±í™”";
            document.getElementById("humAlarmValue").textContent = "ë¹„í™œì„±í™”";
            document.getElementById("lightAlarmValue").textContent = "ë¹„í™œì„±í™”";
            
            // 2. í”¼ì½”ë¡œ ë¹„í™œì„±í™”(ë†’ì€ ê°’) ì„ê³„ê°’ ì „ì†¡
            const thresholds = {
                temperature: highValue,
                humidity: highValue,
                light: highValue
            };
            console.log("ì•ŒëŒ ë¹„í™œì„±í™”, ë†’ì€ ì„ê³„ê°’ ì „ì†¡:", thresholds);
            
            sendDirectAlarmThresholds(thresholds);
        });
      });
      
    </script>
  </body>
</html>