<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IoT í™˜ê²½ ëª¨ë‹ˆí„°ë§ (WiFi Client)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .wifi-instructions {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .wifi-instructions h2 {
        margin-top: 0;
        color: #0d47a1;
        text-align: center;
      }
      .wifi-instructions .ip-input-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        align-items: center; /* ë²„íŠ¼ê³¼ ì¸í’‹ ì •ë ¬ */
      }
      .wifi-instructions input {
        flex: 1;
        padding: 10px;
        font-size: 1.1rem;
        border: 1px solid #90caf9;
        border-radius: 4px;
      }
      /* ì—°ê²° í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .btn-secondary {
        padding: 10px 15px;
        font-size: 0.9rem;
        background: #6c757d;
        color: white;
        white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
      }
      .btn-secondary:hover {
        background: #5a6268;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Roboto", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f8f9fa;
        min-height: 100vh;
        color: #212121;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        padding-top: 100px;
      }
      .header {
        background: white;
        padding: 16px 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        width: 100%;
        box-sizing: border-box;
      }
      .logo {
        height: 40px;
        width: auto;
        object-fit: contain;
      }
      .header-content {
        text-align: center;
        flex: 1;
      }
      .header-content h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #000000;
        margin: 0;
        line-height: 1.2;
      }
      .header-content p {
        font-size: 0.875rem;
        color: #666;
        font-weight: 400;
        margin: 0;
        margin-top: 2px;
      }
      .header-spacer {
        width: 40px;
      }
      .controls {
        background: white;
        padding: 25px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
      }
      .control-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        min-width: 150px;
      }
      .control-group label {
        font-weight: 600;
        color: #555;
        font-size: 0.9rem;
      }
      .slider {
        width: 150px;
        height: 4px;
        border-radius: 2px;
        background: #e0e0e0;
        outline: none;
      }
      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #1976d2;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #1976d2;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        min-width: 120px;
      }
      .btn.giant {
        padding: 20px 40px;
        font-size: 1.2rem;
        font-weight: 600;
        min-width: 200px;
        border-radius: 8px;
      }
      .btn-primary {
        background: #1976d2;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .btn-primary:hover {
        background: #1565c0;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }
      .btn-primary:active {
        background: #0d47a1;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }
      .btn-warning {
        background: #f57c00;
        color: white;
      }
      .btn-warning:hover {
        background: #e65100;
      }

      .status {
        padding: 6px 12px;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 6px;
        min-width: 100px;
        justify-content: center;
      }
      .status.giant {
        padding: 20px 40px;
        border-radius: 8px;
        font-size: 1.2rem;
        font-weight: 600;
        min-width: 200px;
        gap: 10px;
      }
      .status.small {
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: 500;
        min-width: 120px;
        gap: 6px;
      }
      .status.active {
        background: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #4caf50;
      }
      .status.paused {
        background: #fff3e0;
        color: #f57c00;
        border: 1px solid #ff9800;
      }
      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }
      .status.giant .status-indicator {
        width: 12px;
        height: 12px;
      }
      .status-indicator.active {
        background: #4caf50;
      }
      .status-indicator.paused {
        background: #ff9800;
      }
      .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
        justify-items: center;
      }
      .metric-card {
        background: white;
        padding: 25px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        text-align: center;
        transition: box-shadow 0.2s ease;
        width: 200px;
        height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
      }
      .metric-card:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
      }
      .metric-icon {
        font-size: 2rem;
        margin-bottom: 8px;
      }
      .metric-label {
        font-size: 1.2rem;
        color: #666;
        margin-bottom: 8px;
        font-weight: 500;
      }
      .metric-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #333;
        line-height: 1;
      }
      .metric-unit {
        font-size: 0.8rem;
        color: #888;
        margin-left: 3px;
      }
      .metric-status {
        font-size: 0.9rem;
        font-weight: 600;
        margin-top: 8px;
        padding: 4px 8px;
        border-radius: 12px;
        text-align: center;
      }
      .metric-status.normal {
        background: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #4caf50;
      }
      .metric-status.danger {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #f44336;
      }
      .charts-container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
      }
      .chart-container {
        position: relative;
        height: 300px;
        background: #fafafa;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
      }
      .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        text-align: center;
      }
      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }
        .header h1 {
          font-size: 2rem;
        }
        .controls {
          flex-direction: column;
          gap: 20px;
        }
        .metrics {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        .charts-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- ìƒë‹¨ ê³ ì •ë°” -->
      <div class="header">
        <img src="logo.png" alt="Gongdo Logo" class="logo" />
        <div class="header-content">
          <h1>IoT ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ (WiFi Client)</h1>
        </div>
        <div class="header-spacer"></div>
      </div>

      <!-- WiFi ëª¨ë“œ ì—°ê²° ì„¤ì • -->
      <div class="wifi-instructions">
        <h2>â„¹ï¸ WiFi ëª¨ë“œ ì—°ê²° ì„¤ì •</h2>
        <p>
          1. í”¼ì½”ê°€ í•™êµ WiFiì— ì—°ê²°ë˜ë©´, OLEDì— IP ì£¼ì†Œê°€ í‘œì‹œë©ë‹ˆë‹¤. <br />
          2. í•´ë‹¹ IP ì£¼ì†Œë¥¼ ì•„ë˜ ì…ë ¥ì°½ì— ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: 192.168.1.105)
        </p>
        <div class="ip-input-group">
          <input
            type="text"
            id="picoIP"
            placeholder="http:// ì—†ì´ IP ì£¼ì†Œë§Œ ì…ë ¥... (í¬íŠ¸: 8080)"
          />
          <!-- (ì¶”ê°€) ì—°ê²° í…ŒìŠ¤íŠ¸ ë²„íŠ¼ -->
          <button id="testConnectionBtn" class="btn btn-secondary">
            ì—°ê²° í…ŒìŠ¤íŠ¸
          </button>
        </div>
      </div>

      <!-- Controls -->
      <div class="controls">
        <!-- ê°±ì‹  ì£¼ê¸° ìŠ¬ë¼ì´ë” -->
        <div class="control-group">
          <label for="interval">ë°ì´í„° ê°±ì‹  ì£¼ê¸° (ì´ˆ)</label>
          <input
            type="range"
            id="interval"
            class="slider"
            min="0.5"
            max="5"
            step="0.5"
            value="1"
          />
          <span id="intervalValue">1.0ì´ˆ</span>
        </div>
        
        <!-- (ìˆ˜ì •) ì˜¨ë„ ì•ŒëŒ ì„ê³„ì  ìŠ¬ë¼ì´ë” -->
        <div class="control-group">
          <label for="tempAlarmSlider">ì˜¨ë„ ì•ŒëŒ ì„ê³„ì  (Â°C)</label>
          <input
            type="range"
            id="tempAlarmSlider"
            class="slider"
            min="20"
            max="50"
            step="1"
            value="50"
          />
          <span id="tempAlarmValue">ë¹„í™œì„±í™”</span>
        </div>

        <!-- (ì¶”ê°€) ìŠµë„ ì•ŒëŒ ì„ê³„ì  ìŠ¬ë¼ì´ë” -->
        <div class="control-group">
          <label for="humAlarmSlider">ìŠµë„ ì•ŒëŒ ì„ê³„ì  (%)</label>
          <input
            type="range"
            id="humAlarmSlider"
            class="slider"
            min="0"
            max="100"
            step="5"
            value="100"
          />
          <span id="humAlarmValue">ë¹„í™œì„±í™”</span>
        </div>

        <!-- (ì¶”ê°€) ì¡°ë„ ì•ŒëŒ ì„ê³„ì  ìŠ¬ë¼ì´ë” -->
        <div class="control-group">
          <label for="lightAlarmSlider">ì¡°ë„ ì•ŒëŒ ì„ê³„ì  (lx)</label>
          <input
            type="range"
            id="lightAlarmSlider"
            class="slider"
            min="0"
            max="1000"
            step="50"
            value="1000"
          />
          <span id="lightAlarmValue">ë¹„í™œì„±í™”</span>
        </div>
        
        <!-- (ì¶”ê°€) ì„¼ì„œ íƒ€ì… ì„ íƒ -->
        <div class="control-group">
          <label for="sensorTypeSelect">ì„¼ì„œ íƒ€ì… ì„ íƒ</label>
          <select id="sensorTypeSelect" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9rem;">
            <option value="mic">ë§ˆì´í¬</option>
            <option value="water">ìˆ˜ìœ„</option>
          </select>
        </div>
        
        <!-- (ì¶”ê°€) ë§ˆì´í¬ ì•ŒëŒ ì„ê³„ì  ìŠ¬ë¼ì´ë” -->
        <div class="control-group" id="micAlarmGroup">
          <label for="micAlarmSlider">ë§ˆì´í¬ ì•ŒëŒ ì„ê³„ì </label>
          <input
            type="range"
            id="micAlarmSlider"
            class="slider"
            min="0"
            max="5000"
            step="100"
            value="5000"
          />
          <span id="micAlarmValue">ë¹„í™œì„±í™”</span>
        </div>
        
        <!-- (ì¶”ê°€) ìˆ˜ìœ„ ì•ŒëŒ ì„ê³„ì  ìŠ¬ë¼ì´ë” (0~4cm, 40mm) -->
        <div class="control-group" id="waterAlarmGroup" style="display: none;">
          <label for="waterAlarmSlider">ìˆ˜ìœ„ ì•ŒëŒ ì„ê³„ì  (cm)</label>
          <input
            type="range"
            id="waterAlarmSlider"
            class="slider"
            min="0"
            max="4"
            step="0.1"
            value="4"
          />
          <span id="waterAlarmValue">ë¹„í™œì„±í™”</span>
        </div>
        
        <!-- ìƒíƒœ í‘œì‹œ -->
        <div id="status" class="status paused small">
          <div class="status-indicator paused"></div>
          ìƒíƒœ: ëŒ€ê¸° ì¤‘
        </div>
        <div id="picoStatus" class="status paused small">
          <div class="status-indicator paused"></div>
          í”¼ì½”: ì—°ê²° ì•ˆë¨
        </div>
        
        <!-- ë²„íŠ¼ -->
        <button id="startBtn" class="btn btn-primary giant">
          ëª¨ë‹ˆí„°ë§ ì‹œì‘
        </button>
        <!-- (ì¶”ê°€) ì•ŒëŒ ë¹„í™œì„±í™” ë²„íŠ¼ -->
        <button id="disableAlarmBtn" class="btn btn-warning">
          ì•ŒëŒ ë¹„í™œì„±í™”
        </button>
      </div>

      <!-- Metrics -->
      <div class="metrics">
        <div class="metric-card">
          <div class="metric-icon">ğŸŒ¡ï¸</div>
          <div class="metric-label">ì˜¨ë„</div>
          <div class="metric-value">
            <span id="tempValue">--</span>
            <span class="metric-unit">Â°C</span>
          </div>
          <div class="metric-status normal" id="tempStatus">ëŒ€ê¸°</div>
        </div>
        <div class="metric-card">
          <div class="metric-icon">ğŸ’§</div>
          <div class="metric-label">ìŠµë„</div>
          <div class="metric-value">
            <span id="humidityValue">--</span>
            <span class="metric-unit">%</span>
          </div>
          <div class="metric-status normal" id="humidityStatus">ëŒ€ê¸°</div>
        </div>
        <div class="metric-card">
          <div class="metric-icon">ğŸ’¡</div>
          <div class="metric-label">ì¡°ë„</div>
          <div class="metric-value">
            <span id="lightValue">--</span>
            <span class="metric-unit">lx</span>
          </div>
          <div class="metric-status normal" id="lightStatus">ëŒ€ê¸°</div>
        </div>
        <!-- (ì¶”ê°€) ë§ˆì´í¬/ìˆ˜ìœ„ ì„¼ì„œ ì¹´ë“œ -->
        <div class="metric-card" id="adcSensorCard">
          <div class="metric-icon" id="adcSensorIcon">ğŸ¤</div>
          <div class="metric-label" id="adcSensorLabel">ë§ˆì´í¬</div>
          <div class="metric-value">
            <span id="adcSensorValue">--</span>
            <span class="metric-unit" id="adcSensorUnit"></span>
          </div>
          <div class="metric-status normal" id="adcSensorStatus">ëŒ€ê¸°</div>
        </div>
      </div>
      <div class="charts-container">
        <h2 style="text-align: center; margin-bottom: 30px; color: #333">
          ì‹¤ì‹œê°„ ë°ì´í„° ì¶”ì´
        </h2>
        <div class="charts-grid">
          <div class="chart-container">
            <div class="chart-title">ì˜¨ë„</div>
            <canvas id="tempChart"></canvas>
          </div>
          <div class="chart-container">
            <div class="chart-title">ìŠµë„</div>
            <canvas id="humidityChart"></canvas>
          </div>
          <div class="chart-container">
            <div class="chart-title">ì¡°ë„</div>
            <canvas id="lightChart"></canvas>
          </div>
          <!-- (ì¶”ê°€) ë§ˆì´í¬/ìˆ˜ìœ„ ì„¼ì„œ ì°¨íŠ¸ -->
          <div class="chart-container">
            <div class="chart-title" id="adcChartTitle">ë§ˆì´í¬</div>
            <canvas id="adcChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let isCollecting = false;
      let interval = 1000;
      let dataInterval;

      // Chart configurations
      const chartConfig = {
        type: "line",
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: true, grid: { color: "rgba(0,0,0,0.1)" } },
            y: { display: true, grid: { color: "rgba(0,0,0,0.1)" } },
          },
          elements: { point: { radius: 3, hoverRadius: 6 }, line: { borderWidth: 2 } },
        },
      };

      // Initialize charts
      const tempCtx = document.getElementById("tempChart").getContext("2d");
      const humidityCtx = document.getElementById("humidityChart").getContext("2d");
      const lightCtx = document.getElementById("lightChart").getContext("2d");
      const adcCtx = document.getElementById("adcChart").getContext("2d");

      const tempChart = new Chart(tempCtx, {
        ...chartConfig,
        data: {
          labels: [],
          datasets: [
            {
              label: "ì˜¨ë„",
              data: [],
              borderColor: "#f44336",
              backgroundColor: "rgba(244, 67, 54, 0.1)",
              fill: true,
            },
            {
              label: "ìœ„í—˜ ì˜¨ë„",
              data: [],
              borderColor: "#424242",
              backgroundColor: "transparent",
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              pointHoverRadius: 0,
              fill: false,
            },
          ],
        },
      });

      const humidityChart = new Chart(humidityCtx, {
        ...chartConfig,
        options: { ...chartConfig.options, scales: { ...chartConfig.options.scales, y: { ...chartConfig.options.scales.y, beginAtZero: true } } },
        data: {
          labels: [],
          datasets: [
            { data: [], borderColor: "#ff9800", backgroundColor: "rgba(255, 152, 0, 0.1)", fill: true },
            {
              label: "ìœ„í—˜ ìŠµë„",
              data: [],
              borderColor: "#424242",
              backgroundColor: "transparent",
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              pointHoverRadius: 0,
              fill: false,
            },
          ],
        },
      });

      const lightChart = new Chart(lightCtx, {
        ...chartConfig,
        options: { ...chartConfig.options, scales: { ...chartConfig.options.scales, y: { ...chartConfig.options.scales.y, beginAtZero: true } } },
        data: {
          labels: [],
          datasets: [
            { data: [], borderColor: "#fdd835", backgroundColor: "rgba(253, 216, 53, 0.1)", fill: true },
            {
              label: "ìœ„í—˜ ì¡°ë„",
              data: [],
              borderColor: "#424242",
              backgroundColor: "transparent",
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              pointHoverRadius: 0,
              fill: false,
            },
          ],
        },
      });

      // (ì¶”ê°€) ADC ì„¼ì„œ ì°¨íŠ¸ ì´ˆê¸°í™” (ë§ˆì´í¬/ìˆ˜ìœ„)
      const adcChart = new Chart(adcCtx, {
        ...chartConfig,
        options: { ...chartConfig.options, scales: { ...chartConfig.options.scales, y: { ...chartConfig.options.scales.y, beginAtZero: true } } },
        data: {
          labels: [],
          datasets: [
            { 
              label: "ì„¼ì„œ ê°’",
              data: [], 
              borderColor: "#9c27b0", 
              backgroundColor: "rgba(156, 39, 176, 0.1)", 
              fill: true 
            },
            {
              label: "ìœ„í—˜ ì„ê³„ê°’",
              data: [],
              borderColor: "#424242",
              backgroundColor: "transparent",
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              pointHoverRadius: 0,
              fill: false,
            },
          ],
        },
      });

      // ì•ŒëŒ ì„ê³„ê°’ì„ í”¼ì½”ë¡œ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
      async function sendAlarmThresholds() {
        const ip = document.getElementById("picoIP").value;
        if (!ip) {
          console.warn("IP ì£¼ì†Œê°€ ì…ë ¥ë˜ì§€ ì•Šì•„ ì„ê³„ê°’ì„ ì „ì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        const url = `http://${ip}:8080/alarm_threshold`;
        
        const thresholds = {
            temperature: parseFloat(document.getElementById("tempAlarmSlider").value),
            humidity: parseFloat(document.getElementById("humAlarmSlider").value),
            light: parseFloat(document.getElementById("lightAlarmSlider").value)
        };
        
        // (ì¶”ê°€) ë§ˆì´í¬/ìˆ˜ìœ„ ì„ê³„ê°’ ì¶”ê°€
        const sensorType = document.getElementById("sensorTypeSelect").value;
        if (sensorType === "mic") {
            thresholds.mic = parseFloat(document.getElementById("micAlarmSlider").value);
        } else if (sensorType === "water") {
            thresholds.water = parseFloat(document.getElementById("waterAlarmSlider").value);
        }
        
        // (ìˆ˜ì •) "ë¹„í™œì„±í™”" ìƒíƒœ(ìŠ¬ë¼ì´ë” ìµœëŒ€ê°’)ë©´ 100ë§Œìœ¼ë¡œ ì „ì†¡
        const highValue = 1000000;
        if (thresholds.temperature >= 50) thresholds.temperature = highValue;
        if (thresholds.humidity >= 100) thresholds.humidity = highValue;
        if (thresholds.light >= 1000) thresholds.light = highValue;
        if (thresholds.mic && thresholds.mic >= 5000) thresholds.mic = highValue;
        if (thresholds.water && thresholds.water >= 4) thresholds.water = highValue;

        console.log("ìƒˆ ì„ê³„ê°’ ì „ì†¡ ì‹œë„:", thresholds);
        
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(thresholds)
          });
          if (response.ok) {
            console.log(`ì„±ê³µ: ìƒˆ ì•ŒëŒ ì„ê³„ê°’ ì „ì†¡ ì™„ë£Œ`, thresholds);
          } else {
            console.error(`ì‹¤íŒ¨: ì„ê³„ê°’ ì „ì†¡ ì‹¤íŒ¨ (HTTP ${response.status})`);
          }
        } catch (error) {
          console.error("ì„ê³„ê°’ ì „ì†¡ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
          updatePicoStatus(false);
        }
      }

      // Fetch data from Raspberry Pi Pico (WiFi Client ëª¨ë“œ)
      async function fetchPicoData() {
        const ip = document.getElementById("picoIP").value;
        if (!ip) {
          console.warn("IP ì£¼ì†Œê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          updatePicoStatus(false);
          return;
        }
        
        const PICO_API_URL = `http://${ip}:8080/sensors`;
        
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 2000);

          const response = await fetch(PICO_API_URL, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
            signal: controller.signal,
          });
          clearTimeout(timeoutId);

          if (response.ok) {
            const picoData = await response.json();
            updateMetrics(picoData);
            updateCharts(picoData);
            updatePicoStatus(true);
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.log("Pico not connected:", error.message);
          updatePicoStatus(false);
        }
      }

      // Update Pico connection status display
      function updatePicoStatus(connected) {
        const picoStatus = document.getElementById("picoStatus");
        if (connected) {
          picoStatus.innerHTML = '<div class="status-indicator active"></div>í”¼ì½”: ì—°ê²°ë¨';
          picoStatus.className = "status active small";
        } else {
          picoStatus.innerHTML = '<div class="status-indicator paused"></div>í”¼ì½”: ì—°ê²° ì•ˆë¨';
          picoStatus.className = "status paused small";
        }
      }

      // Update metrics display
      function updateMetrics(data) {
        if (data.error) {
          console.error("Sensor error:", data.error);
          updatePicoStatus(false);
          return;
        }
        document.getElementById("tempValue").textContent = data.temperature;
        document.getElementById("humidityValue").textContent = data.humidity;
        document.getElementById("lightValue").textContent = data.light;
        
        // (ì¶”ê°€) ë§ˆì´í¬/ìˆ˜ìœ„ ì„¼ì„œ ë°ì´í„° ì—…ë°ì´íŠ¸
        const sensorType = data.sensor_type || "mic";
        const adcSensorIcon = document.getElementById("adcSensorIcon");
        const adcSensorLabel = document.getElementById("adcSensorLabel");
        const adcSensorValue = document.getElementById("adcSensorValue");
        const adcSensorUnit = document.getElementById("adcSensorUnit");
        
        if (sensorType === "mic" && data.mic !== undefined) {
          adcSensorIcon.textContent = "ğŸ¤";
          adcSensorLabel.textContent = "ë§ˆì´í¬";
          adcSensorValue.textContent = data.mic;
          adcSensorUnit.textContent = "";
        } else if (sensorType === "water" && data.water_distance !== undefined) {
          adcSensorIcon.textContent = "ğŸ’§";
          adcSensorLabel.textContent = "ìˆ˜ìœ„";
          adcSensorValue.textContent = data.water_distance.toFixed(2);
          adcSensorUnit.textContent = " cm";
        }
        
        updateStatusIndicators(data);
      }

      // Update status indicators
      function updateStatusIndicators(data) {
        const highValue = 1000000;
        
        // ì˜¨ë„ ì„ê³„ê°’ í™•ì¸
        const tempThreshold = parseFloat(document.getElementById("tempAlarmSlider").value);
        const tempAlarmActive = tempThreshold < 50 && data.temperature > tempThreshold;
        const tempStatus = document.getElementById("tempStatus");
        tempStatus.textContent = tempAlarmActive ? "ìœ„í—˜" : "ì •ìƒ";
        tempStatus.className = tempAlarmActive ? "metric-status danger" : "metric-status normal";
        
        // ìŠµë„ ì„ê³„ê°’ í™•ì¸
        const humThreshold = parseFloat(document.getElementById("humAlarmSlider").value);
        const humAlarmActive = humThreshold < 100 && data.humidity > humThreshold;
        const humStatus = document.getElementById("humidityStatus");
        humStatus.textContent = humAlarmActive ? "ìœ„í—˜" : "ì •ìƒ";
        humStatus.className = humAlarmActive ? "metric-status danger" : "metric-status normal";
        
        // ì¡°ë„ ì„ê³„ê°’ í™•ì¸
        const lightThreshold = parseFloat(document.getElementById("lightAlarmSlider").value);
        const lightAlarmActive = lightThreshold < 1000 && data.light > lightThreshold;
        const lightStatus = document.getElementById("lightStatus");
        lightStatus.textContent = lightAlarmActive ? "ìœ„í—˜" : "ì •ìƒ";
        lightStatus.className = lightAlarmActive ? "metric-status danger" : "metric-status normal";
        
        // ë§ˆì´í¬/ìˆ˜ìœ„ ì„¼ì„œ ì„ê³„ê°’ í™•ì¸
        const sensorType = data.sensor_type || "mic";
        const adcSensorStatus = document.getElementById("adcSensorStatus");
        
        if (sensorType === "mic" && data.mic !== undefined) {
          const micThreshold = parseFloat(document.getElementById("micAlarmSlider").value);
          const micAlarmActive = micThreshold < 5000 && data.mic > micThreshold;
          adcSensorStatus.textContent = micAlarmActive ? "ìœ„í—˜" : "ì •ìƒ";
          adcSensorStatus.className = micAlarmActive ? "metric-status danger" : "metric-status normal";
        } else if (sensorType === "water" && data.water_distance !== undefined) {
          const waterThreshold = parseFloat(document.getElementById("waterAlarmSlider").value);
          // ìˆ˜ìœ„ëŠ” ì„ê³„ê°’ì„ ë„˜ì–´ì„°ì„ ë•Œ ìœ„í—˜ìœ¼ë¡œ í‘œì‹œ
          const waterAlarmActive = waterThreshold < 4 && data.water_distance > waterThreshold;
          adcSensorStatus.textContent = waterAlarmActive ? "ìœ„í—˜" : "ì •ìƒ";
          adcSensorStatus.className = waterAlarmActive ? "metric-status danger" : "metric-status normal";
        }
      }

      // Update charts
      function updateCharts(data) {
        if (data.error) return;
        const now = new Date().toLocaleTimeString();

        // (ìˆ˜ì •) ì°¨íŠ¸ì˜ ì„ê³„ì„ ë„ UI ìŠ¬ë¼ì´ë” ê°’ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ë³€ê²½
        const tempThreshold = parseFloat(document.getElementById("tempAlarmSlider").value);
        const humThreshold = parseFloat(document.getElementById("humAlarmSlider").value);
        const lightThreshold = parseFloat(document.getElementById("lightAlarmSlider").value);
        
        // ì˜¨ë„ ì°¨íŠ¸
        tempChart.data.labels.push(now);
        tempChart.data.datasets[0].data.push(data.temperature);
        tempChart.data.datasets[1].data.push(tempThreshold >= 50 ? null : tempThreshold); // ë¹„í™œì„±í™”(50)ì‹œ ì„  ì•ˆê·¸ë¦¼
        if (tempChart.data.labels.length > 20) {
          tempChart.data.labels.shift();
          tempChart.data.datasets[0].data.shift();
          tempChart.data.datasets[1].data.shift();
        }
        tempChart.update("none");

        // ìŠµë„ ì°¨íŠ¸
        humidityChart.data.labels.push(now);
        humidityChart.data.datasets[0].data.push(data.humidity);
        humidityChart.data.datasets[1].data.push(humThreshold >= 100 ? null : humThreshold); 
        if (humidityChart.data.labels.length > 20) {
          humidityChart.data.labels.shift();
          humidityChart.data.datasets[0].data.shift();
          humidityChart.data.datasets[1].data.shift(); 
        }
        humidityChart.update("none");

        // ì¡°ë„ ì°¨íŠ¸
        lightChart.data.labels.push(now);
        lightChart.data.datasets[0].data.push(data.light);
        lightChart.data.datasets[1].data.push(lightThreshold >= 1000 ? null : lightThreshold); 
        if (lightChart.data.labels.length > 20) {
          lightChart.data.labels.shift();
          lightChart.data.datasets[0].data.shift();
          lightChart.data.datasets[1].data.shift(); 
        }
        lightChart.update("none");

        // (ì¶”ê°€) ADC ì„¼ì„œ ì°¨íŠ¸ (ë§ˆì´í¬/ìˆ˜ìœ„)
        const sensorType = data.sensor_type || "mic";
        const adcChartTitle = document.getElementById("adcChartTitle");
        
        if (sensorType === "mic" && data.mic !== undefined) {
          adcChartTitle.textContent = "ë§ˆì´í¬";
          const micThreshold = parseFloat(document.getElementById("micAlarmSlider").value);
          adcChart.data.labels.push(now);
          adcChart.data.datasets[0].data.push(data.mic);
          adcChart.data.datasets[1].data.push(micThreshold >= 5000 ? null : micThreshold);
        } else if (sensorType === "water" && data.water_distance !== undefined) {
          adcChartTitle.textContent = "ìˆ˜ìœ„";
          const waterThreshold = parseFloat(document.getElementById("waterAlarmSlider").value);
          adcChart.data.labels.push(now);
          adcChart.data.datasets[0].data.push(data.water_distance);
          // ì„ê³„ê°’ì„ ê¸°ì¤€ì„ ìœ¼ë¡œ ì‚¬ìš© (ìˆ˜ìœ„ê°€ ì´ ê°’ì„ ë„˜ìœ¼ë©´ ìœ„í—˜)
          adcChart.data.datasets[1].data.push(waterThreshold >= 4 ? null : waterThreshold);
        }
        
        if (adcChart.data.labels.length > 20) {
          adcChart.data.labels.shift();
          adcChart.data.datasets[0].data.shift();
          adcChart.data.datasets[1].data.shift();
        }
        adcChart.update("none");
      }

      // Start/stop data collection
      function toggleCollection() {
        if (isCollecting) {
          clearInterval(dataInterval);
          isCollecting = false;
          document.getElementById("startBtn").textContent = "ëª¨ë‹ˆí„°ë§ ì‹œì‘";
          document.getElementById("status").innerHTML = '<div class="status-indicator paused"></div>ìƒíƒœ: ì¤‘ì§€ë¨';
          document.getElementById("status").className = "status paused small";
        } else {
          const ip = document.getElementById("picoIP").value;
          if (!ip) {
            alert("í”¼ì½” IP ì£¼ì†Œë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.");
            return;
          }
          
          fetchPicoData(); 
          dataInterval = setInterval(fetchPicoData, interval);
          
          isCollecting = true;
          document.getElementById("startBtn").textContent = "ëª¨ë‹ˆí„°ë§ ì¤‘ì§€";
          document.getElementById("status").innerHTML = '<div class="status-indicator active"></div>ìƒíƒœ: ëª¨ë‹ˆí„°ë§ ì¤‘';
          document.getElementById("status").className = "status active small";
        }
      }

      // Test Pico connection
      async function testPicoConnection() {
        const ip = document.getElementById("picoIP").value;
        if (!ip) {
          updatePicoStatus(false);
          alert("IP ì£¼ì†Œë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }
        const PICO_API_URL = `http://${ip}:8080/sensors`;
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 2000); // 2ì´ˆ íƒ€ì„ì•„ì›ƒ
          
          const response = await fetch(PICO_API_URL, { signal: controller.signal });
          clearTimeout(timeoutId);
          
          updatePicoStatus(response.ok);
          if(response.ok) {
            alert("âœ… í”¼ì½” ì—°ê²° ì„±ê³µ!");
          } else {
            alert("âŒ í”¼ì½” ì—°ê²° ì‹¤íŒ¨: IP ì£¼ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”.");
          }
        } catch (error) {
          updatePicoStatus(false);
          alert("âŒ í”¼ì½” ì—°ê²° ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” IP ì£¼ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        }
      }
      
      // ë¹„í™œì„±í™” ë²„íŠ¼ìš© ì „ì†¡ í•¨ìˆ˜
      async function sendDirectAlarmThresholds(thresholds) {
        const ip = document.getElementById("picoIP").value;
        if (!ip) {
          alert("IP ì£¼ì†Œë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }
        const url = `http://${ip}:8080/alarm_threshold`;
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(thresholds)
          });
          if (response.ok) {
            console.log("ì„±ê³µ: ì•ŒëŒ ë¹„í™œì„±í™” ì™„ë£Œ", thresholds);
          } else {
            console.error(`ì‹¤íŒ¨: ì•ŒëŒ ë¹„í™œì„±í™” ì‹¤íŒ¨ (HTTP ${response.status})`);
          }
        } catch (error) {
          console.error("ì•ŒëŒ ë¹„í™œì„±í™” ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
          updatePicoStatus(false);
        }
      }

      // (ì¶”ê°€) ì„¼ì„œ íƒ€ì… ë³€ê²½ í•¨ìˆ˜
      async function changeSensorType(newType) {
        const ip = document.getElementById("picoIP").value;
        if (!ip) {
          console.warn("IP ì£¼ì†Œê°€ ì…ë ¥ë˜ì§€ ì•Šì•„ ì„¼ì„œ íƒ€ì…ì„ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        const url = `http://${ip}:8080/sensor_type`;
        
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: newType })
          });
          
          if (response.ok) {
            console.log(`ì„¼ì„œ íƒ€ì… ë³€ê²½ ì„±ê³µ: ${newType}`);
            // UI ì—…ë°ì´íŠ¸
            if (newType === "mic") {
              document.getElementById("micAlarmGroup").style.display = "flex";
              document.getElementById("waterAlarmGroup").style.display = "none";
            } else {
              document.getElementById("micAlarmGroup").style.display = "none";
              document.getElementById("waterAlarmGroup").style.display = "flex";
            }
            // í˜„ì¬ ì„ê³„ê°’ ì „ì†¡
            sendAlarmThresholds();
          } else {
            console.error(`ì„¼ì„œ íƒ€ì… ë³€ê²½ ì‹¤íŒ¨ (HTTP ${response.status})`);
          }
        } catch (error) {
          console.error("ì„¼ì„œ íƒ€ì… ë³€ê²½ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
          updatePicoStatus(false);
        }
      }

      // Event listeners
      document.addEventListener("DOMContentLoaded", function () {
        
        const startBtn = document.getElementById("startBtn");
        startBtn.addEventListener("click", toggleCollection);
        
        const testBtn = document.getElementById("testConnectionBtn");
        testBtn.addEventListener("click", testPicoConnection);

        const intervalSlider = document.getElementById("interval");
        intervalSlider.addEventListener("input", function () {
            interval = this.value * 1000;
            document.getElementById("intervalValue").textContent = this.value + "ì´ˆ";
            if (isCollecting) {
              clearInterval(dataInterval);
              dataInterval = setInterval(fetchPicoData, interval);
            }
        });
        
        // --- 3ê°œì˜ ì•ŒëŒ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        const tempSlider = document.getElementById("tempAlarmSlider");
        const humSlider = document.getElementById("humAlarmSlider");
        const lightSlider = document.getElementById("lightAlarmSlider");
        const highValue = 1000000;

        // UI í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ë“œë˜ê·¸ ì¤‘ ì‹¤ì‹œê°„)
        tempSlider.addEventListener("input", () => {
             const val = parseFloat(tempSlider.value);
             document.getElementById("tempAlarmValue").textContent = 
                (val >= 50) ? "ë¹„í™œì„±í™”" : val.toFixed(1) + "Â°C";
        });
        humSlider.addEventListener("input", () => {
             const val = parseFloat(humSlider.value);
             document.getElementById("humAlarmValue").textContent = 
                (val >= 100) ? "ë¹„í™œì„±í™”" : val.toFixed(1) + "%";
        });
        lightSlider.addEventListener("input", () => {
             const val = parseFloat(lightSlider.value);
             document.getElementById("lightAlarmValue").textContent = 
                (val >= 1000) ? "ë¹„í™œì„±í™”" : val.toFixed(0) + " lx";
        });

        // í”¼ì½”ë¡œ ë°ì´í„° ì „ì†¡ (ë§ˆìš°ìŠ¤ë¥¼ ë†“ì•˜ì„ ë•Œ)
        tempSlider.addEventListener("change", sendAlarmThresholds);
        humSlider.addEventListener("change", sendAlarmThresholds);
        lightSlider.addEventListener("change", sendAlarmThresholds);
        
        // (ì¶”ê°€) ë§ˆì´í¬/ìˆ˜ìœ„ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const micSlider = document.getElementById("micAlarmSlider");
        const waterSlider = document.getElementById("waterAlarmSlider");
        
        micSlider.addEventListener("input", () => {
          const val = parseFloat(micSlider.value);
          document.getElementById("micAlarmValue").textContent = 
            (val >= 5000) ? "ë¹„í™œì„±í™”" : val.toFixed(0);
        });
        
        waterSlider.addEventListener("input", () => {
          const val = parseFloat(waterSlider.value);
          document.getElementById("waterAlarmValue").textContent = 
            (val >= 4) ? "ë¹„í™œì„±í™”" : val.toFixed(1) + " cm";
        });
        
        micSlider.addEventListener("change", sendAlarmThresholds);
        waterSlider.addEventListener("change", sendAlarmThresholds);
        
        // (ì¶”ê°€) ì„¼ì„œ íƒ€ì… ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const sensorTypeSelect = document.getElementById("sensorTypeSelect");
        sensorTypeSelect.addEventListener("change", function() {
          const newType = this.value;
          changeSensorType(newType);
        });
        
        // ì•ŒëŒ ë¹„í™œì„±í™” ë²„íŠ¼
        document.getElementById("disableAlarmBtn").addEventListener("click", () => {
            
            // 1. UI ìŠ¬ë¼ì´ë”ì™€ í…ìŠ¤íŠ¸ë¥¼ ìµœëŒ€/ë¹„í™œì„±í™” ìƒíƒœë¡œ ë³€ê²½
            tempSlider.value = 50; 
            humSlider.value = 100;
            lightSlider.value = 1000;
            micSlider.value = 5000;
            waterSlider.value = 4;
            document.getElementById("tempAlarmValue").textContent = "ë¹„í™œì„±í™”";
            document.getElementById("humAlarmValue").textContent = "ë¹„í™œì„±í™”";
            document.getElementById("lightAlarmValue").textContent = "ë¹„í™œì„±í™”";
            document.getElementById("micAlarmValue").textContent = "ë¹„í™œì„±í™”";
            document.getElementById("waterAlarmValue").textContent = "ë¹„í™œì„±í™”";
            
            // 2. í”¼ì½”ë¡œ ë¹„í™œì„±í™”(ë†’ì€ ê°’) ì„ê³„ê°’ ì „ì†¡
            const thresholds = {
                temperature: highValue,
                humidity: highValue,
                light: highValue,
                mic: highValue,
                water: highValue
            };
            console.log("ì•ŒëŒ ë¹„í™œì„±í™”, ë†’ì€ ì„ê³„ê°’ ì „ì†¡:", thresholds);
            
            sendDirectAlarmThresholds(thresholds);
        });
      });
      
    </script>
  </body>
</html>